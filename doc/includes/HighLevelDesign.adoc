# High Level Design
// intended empty

## Key Design Decisions and Alternatives
// intended empty

### RSS checks and response
The RSS module is the entity performing all RSS checks and operations.
It will perform checks on the current state of the environment,
in order to determine if the ego vehicle is currently in a safe state.
If the ego vehicle is not in a safe state, the RSS module will provide a response
action that will bring the car back into a safe state.

The state is regarded as safe, if the ego vehicle is not causing a collision with
another object, under the worst case assumption that the ego vehicle will
accelerate at maximum possible speed during its response time.
Hence for this check the RSS module does not take the current desired behavior
as given by the driving policy into account.
However as the RSS modules makes a worst case assumption, it is guaranteed that
if the RSS module regards the situation as safe, no valid action of
the driving policy can bring the vehicle into an unsafe state.

If the vehicle is in a dangerous situation, RSS will assure a proper reaction
that will bring the car back into a safe state.
Therefore, it will check whether the driving policy responds correctly to the
situation.
If yes the command given by the driving policy will be executed. But if the
driving policy command is conflicting with the response that RSS expects,
RSS will prevent the command from being executed and will provide a proper
command instead.

This will assure that the vehicle reacts correctly. But the driving policy still
has the chance to solve the dangerous situation
on a more elaborate way than RSS would be able to, as RSS only has basic
information about the environment.

To check whether the ego vehicle is in a safe state, all the objects in the
surrounding must be respected. To do so the RSS module will perform an analysis
against all the objects in the environment individually. Meaning, for each
object in the environment the RSS module will check whether the ego vehicle
conflicts with this object.


### Lateral evasive maneuvers
If the car finds itself in a dangerous situation one possible action is always
to brake. According to the RSS papers, this should always result
in a safe state, but might lead in worst case to a complete stop of the vehicle.
The RSS paper proposes that the car may perform also lateral maneuvers as a
response to certain dangerous situations. To do so, it must be assured that
this lateral movement brings the vehicle into a safe state and does not conflict
with another vehicle.
In order to determine whether a lateral movement solves the conflict a
prediction of the state would be necessary.
However, such a prediction for all objects comes with a high uncertainty,
and therefore, would not be reliable.
In addition to that RSS just has only visibility of the objects in
the environment. It cannot determine that a lateral movement initiated by RSS
will cause an accident with static obstacles.

Therefore, it is impossible for the RSS module to detect whether a lateral
evasion is really feasible.
In order to guarantee that the dangerous situation is solved, RSS will restrict
the movement in the dangerous direction. Though, to allow the driving policy to
find a better escape for the current situation, the RSS response will not be
send directly to the actuators.
It will just make sure the command of the driving policy is not conflicting
with the response given by RSS.
With this approach e.g. in a scenario where another vehicle cuts into
the lane of the ego vehicle, RSS will propose a lateral deceleration towards
the intersecting car. Hence, it will neglect steering towards direction
of the other vehicle. But the driving policy can still steer to the
opposite direction e.g. on an adjacent lane to avoid a collision.


### Response for vehicles driving in opposite directions

If two vehicles are approaching each other in opposite direction and the lateral
distance between them is not safe, the RSS paper defines that the car that is on
its own lane can brake with lower force than the car on the opposite direction.
This definition leads to a correct behavior, if it is obvious that one car is on
its own lane and the other car is driving on the lane belonging to the other car.

However, there are situations where this cannot be determined.
One situation e.g. is that there is a bidirectional single lane road.
For sure on such a road each car should drive on the right side, but it cannot
 be easily detected which car is no longer on its side of the road.

Another situation is that there is a two lane road with one lane for each
direction. If each car drives on its own lane but is very close to the left
border, it could lead to a lateral conflict, as the safe lateral distance
requires a safety margin. In this situation both cars are on the correct lane,
but still there is a lateral conflict. In a real world scenario things can get
even worse.
As sensing will never be 100% accurate, small errors in the perception
system can lead to an interpretation that one or even both cars
believe that they are themselves on the correct lane and the other car is
on the wrong lane. Therefore, each car will brake with low force and expects
the other car to brake more strongly. Consequently, this dangerous situation
will never be solved and the cars will crash.

To avoid such a catastrophic situation, the RSS module
will extend the rule given by the paper to the following.

Given a situation that two cars approach each other with
a lateral conflict, the following rules apply:

1. Both cars must brake according to the "stated braking pattern",
   if the longitudinal distance is not safe given that both cars
   accelerate at maximum during their response time and brake with
   &alpha;~min,brake~ (as defined in the paper).

2. If case 1 does not apply, and the longitudinal distance is not safe
   according to the definition in "Safe Longitudinal Distance for Opposite Directions",
   the vehicle on the correct lane has to brake with &alpha;~min,brake,correct~,
   and the vehicle on the wrong lane has to conduct the "stated braking pattern"
   (This is the situation described in the RSS paper).

### Response Time
According to the papers each traffic participant has a response time.
Within this response time the participants (including the ego vehicle) are allowed
to accelerate, and thus increase their velocity.

In addition, the distance covered during the response time is part of the safe
distance, as defined by RSS. Hence, upon entering a dangerous situation,
it would be possible to accelerate for at most t < response time, as this
acceleration is already considered.

Nevertheless, the RSS module will immediately issue a response action (longitudinal
or lateral braking maneuver). To ensure that the dangerous situation is evaded
as fast as possible.



### Lane-Based Coordinate System
As described in the paper, RSS assumes that the road is comprised by adjacent,
straight lanes, of constant width. Therefore, it is required to transform the object
states from Cartesian into Lane space.

The transformation into a lane-based coordinate system is described by a
bijective function. Therein, the lateral position of a vehicle within the lane is mapped to a
parametric interval _[-^1^/~2~; ^1^/~2~]_, where the lane boundaries are fixed at the borders of the interval.

[[comparing_velocities]]
#### Comparing velocities and accelerations between lane-based coordinate systems
As a consequence, besides the position also the velocities and accelerations have to be
transformed into the lane-based coordinate system.
As a matter of fact, the resulting values depend on the actual lane geometry,
and thus, velocities and accelerations of different lane-based coordinate systems
cannot be compared to each other anymore.

##### Two parallel lanes, different width
*TODO* create and insert image for explanation

Let us illustrate this on a simple example with two parallel lanes of different width.
Let the left lane A have a constant width of _4 m_ where the right lane B
only has a constant width of _2 m_.
If both lanes define their own lane-based coordinate system _LCS~A~_ and _LCS~B~_,
a Cartesian lateral acceleration value of _1 m/s^2^_ becomes _0.25 lat/s^2^_
in _LCS~A~_ and _0.5 lat/s^2^_ in _LCS~B~_. Therefore, the formula for constant accelerated
movement has to use different acceleration constants in different lanes.
This situation is getting even worse, if a car is changing the lane from lane A to lane B:
then the closed formula for constant accelerated movement to calculate the lateral
distance over time cannot be applied anymore directly.

##### Lane is widening
*TODO* create and insert image for explanation

Let us consider a lane with changing width in another example.
If the lane's width at the beginning is _4 m_ and _100 m_ away the lane is narrowing
to _2 m_. In such a case the Cartesian lateral acceleration value of _1 m/s^2^_ is
changing from _0.25 lat/s^2^_ at the beginning towards _0.5 lat/s^2^_ while advancing
within the lane.

##### Lane with a narrow curve
*TODO* create and insert image for explanation

This section illustrates a longitudinal situation similar to the lane widening
example. Let's assume the lane has a constant width of _4 m_ describing a curve with
inner radius of _50 m_ covering _180¬∞_. The inner border of the lane has a length
of about _157.1 m_, the center line _163.4 m_ the outer border _169.7 m_.
In that situation a longitudinal acceleration value will evaluate
to _1.0 lon/s^2^_ for the center line, _0.96 lon/s^2^_ for the outer border and
_1.04 lon/s^2^_ for the inner border. Therefore, the longitudinal acceleration
changes over time, if the vehicle changes its lateral position within the lane.

##### Summary
As sketched in the previous sections both the longitudinal as well as the
lateral acceleration values within the lane-based coordinate system cannot be
considered as constant anymore.

#### Design alternative: Iterative Approach [optional]
*TODO* create and insert image for explanation

One possible way to handle these non-constant acceleration values
would be an iterative approach: based on the
position, the velocity and the acceleration values at the given position at time
_t~0~_, the position at time _t~1~_ is calculated. The smaller the time
interval between the iteration steps is chosen, the smaller the calculation error
gets.

One drawback of the iterative approach is that the RSS implementation has to get
to know the lane geometries in detail to be able to calculate the acceleration
values to be used for every position within the lane-based coordinate systems.
Therefore, this design approach is not selected by this RSS module implementation.

#### Design alternative: Individual lane-based coordinate system with properly scaled acceleration values
Since RSS performs a worst case assessment the idea followed by this RSS module implementation
is to scale the min/max acceleration values for calculation of the safe distances
in order to adapt to the observed situation individually.
Like this, it is assured that the calculations are sound,
nevertheless this might lead to a more cautious behavior of the vehicle.
The following subsections describe the selected approach in more detail.

##### Two parallel lanes, different width
*TODO* create and insert image for explanation

As described in section <<comparing_velocities>>, the border between neighboring lanes
of different width introduces discontinuities of the lateral acceleration values.

As the RSS module judges the relative situation between the ego vehicle
and the other objects one by one individually, it is not required to distinguish
between the actual lanes within the individual distance calculations.
Combining all lanes relevant for the individual situation _s~i~_
between ego vehicle and object _o~i~_ into one single lane-based coordinate system
_LCS~i~_ resolves all discontinuities.

Coming back to the concrete example from above, left lane A having a constant
width of _4 m_ and right lane B having a constant width of _2 m_, both lanes
together have a resulting width of _6 m_. A Cartesian lateral acceleration value of
_&alpha; = 1 m/s^2^_ becomes an acceleration value of
_&alpha;~i~ = 1/6 lat/s^2^ = 0.167 lat/s^2^_ within the individual situation specific
lane-based coordinate system _LCS~i~_.

The check of the ego vehicle with another object _o~j~_ which might be
two lanes at the right of the ego vehicle in a lane C having a constant width
of _3 m_, has to take all three lanes into account with resulting width of _9 m_.
Therefore, a different lane-based coordinate system _LCS~j~_ is required using
a different acceleration value of _&alpha;~j~ = 1/9 lat/s^2^ = 0.111 lat/s^2^_.

##### Lane is widening or has a narrow curve
The individual situation specific lane-based coordinate system _LCS_ does
not yet cover the situations of widening lanes or narrow curves.
To take the variation of the lane width and length into account, it is required
to scale the applied acceleration values within the respective _LCS_ accordingly.

*TODO* create and insert image for explanation

Again, coming back to the examples from above, let's have a lane with non constant width
between _2 m_ and _4 m_. Then the transformation of the maximum possible acceleration
into the lane coordinate system _LCS_ has to take the minimum width of _2 m_
into account, while the transformation of the deceleration values has to be
transformed with the maximum width of the lane of _4 m_.
Like this it's guaranteed that we neither underestimate the acceleration
of the vehicles towards each other nor overestimate the deceleration of the
vehicles while braking. As a result, it is ensured that under all conditions,
the safety distances are calculated in a conservative manner.

*TODO* create and insert image for explanation

In a similar way, it is possible to transform the longitudinal acceleration values
into a lane-based coordinate system _LCS~k~_.
Taking the nominal center line length (in the above example: _163.4 m_) as basis,
we have to apply the factors _scale^lon^~k,min~ = 0.96_ and
_scale^lon^~k,max~ = 1.04_ appropriately to consider the
minimum and maximum lane length of _157.1 m_ and _169.7 m_.
The decision on which of the two factors has to be selected for which of the
acceleration/deceleration values depends also on the situation
between ego vehicle and the actual object.

In case the ego vehicle is following object _o~k~_ within the same lane,
the acceleration value of the ego vehicle
(_&alpha;^ego^~accel,k~ = &alpha;~accel~ * scale^lon^~k,max~_)
as well as the deceleration values of the object _o~k~_
(_&alpha;^o^~brake,k~ = &alpha;~brake~ * scale^lon^~k,max~_)
have to be scaled with the maximum scale factor _1.04_, whereas the deceleration
of the ego vehicle
(_&alpha;^ego^~brake,k~ = &alpha;~brake~ * scale^lon^~k,min~_)
and the acceleration of the object
(_&alpha;^o^~accel,k~ = &alpha;~accel~ * scale^lon^~k,min~_)
have to be scaled with the minimum scale factor _0.96_.
This has to be adapted in case the ego vehicle is the vehicle in front or the
object is approaching from the opposite direction.
Nevertheless, there is always a selection possible that guarantees that the
worst case is covered.

It is to mention, that in these calculations the actual shape of the lane is not
used. Therefore, detailed knowledge of the actual lane geometry is not required.
The absolute maximum and minimum width and length values of the lane
segments is sufficient to calculate a proper transformation into the
space of the individual lane-based coordinate systems.

*TODO* create and insert image for explanation, that also curvy and strange lane
borders are covered easily

##### Summary
The presented construction of a continuous lane-based coordinates system
will allow the pairwise calculation of the safe distances between ego vehicle
and objects with the assumption of constant acceleration.
Still, the worst case assessment of RSS is not violated.
This lane-based coordinate system in conjunction with the situation specific
scaling of the applied acceleration and braking values allows the calculation
of the safe distances, the decision on dangerous situations and deduction of
a proper response.

##### Considerations on reverse transformation of the proper response
As the proper response is referring to the individual lane-based coordinate
systems, the response has to be transformed back into Cartesian space.
A simple example illustrates this: a vehicle driving in a curve will for sure
have to perform a lateral acceleration in Cartesian space
otherwise it will leave the lane because of the centripedal force.

*TODO* create and insert image for explanation

Because the proper response of RSS is defined with respect to the actual lane the
vehicle is driving in, it is required to assure that the reverse transformation of the
proper response considers only the ego-lane and not the individual lane-based
coordinate systems.
For example, one widening lane A and one narrowing lane B are neighbors in such a way
that the overall width of the road is constantly _6 m_. Lane A starts with _2 m_
and ends with _4 m_ width, whereas lane B starts with _4 m_ and ends with _2 m_
width. A lateral velocity of 0 in respect to the whole road differs from the
definition of a lateral velocity of 0 in lane A/lane B in Cartesian space.

*TODO* create and insert image for explanation

### Parameter Definition and Alternatives
The RSS papers use a few constants required for the safety calculations.
The values for these constants are not defined and open for discussion/regulation.
Nevertheless, the implementation of the RSS modules needs to define initial values
for these functions. The parameters will be implemented as configuration values
so these can be easily adjusted during evaluation or after the release.

In the following, the key parameters and the decision for their initial values are
discussed. The used parameters are:

* Response time &rho;.
  It is assumed that an AV vehicle has a shorter response
  time than a human driver. Therefore, there is a need to have two different parameters.
  As it might not be possible to determine whether another object is an AV vehicle
  or has a human driver, the RSS module will safely assume that all other objects
  are driven by humans. Hence, two parameters for the response time are used.
** &rho;~ego~ for the ego vehicle
** &rho;~other~ for all other objects

* Acceleration &alpha;.
  RSS proposes several different acceleration/deceleration
  values. One could argue that acceleration/deceleration differs with the type
  of vehicle. Also at least the acceleration is dependent on the current vehicle speed.
  As it cannot be assured that the individual acceleration of each and every car
  can be known and the specific car can be reliably detected, the RSS module will
  assume fixed constants for those values. These could be either the maximum
  physically possible values or restrictions that are imposed by regulation.
  Also there will not be different values for the ego vehicle and the other vehicles.
  It could be argued that for the ego vehicle e.g. desired acceleration might be known.
  Therefore, a shorter safety distance would be sufficient. But as all other
  vehicles do not know about the intention of the ego vehicle this would lead
  to a violation of their safe space. So the RSS module will need to calculate
  its checks with the globally defined accelerations values even if the vehicle
  does not intend to utilize them to its limits.
  The parameters used for acceleration are:
** &alpha;~accel,max~ maximum possible acceleration
** &alpha;~brake,min~ minimum allowed braking deceleration for most scenarios
** &alpha;~brake,max~ maximum allowed deceleration
** &alpha;~brake,min,correct~ minimum allowed deceleration for a car on its lane with
   another car approaching on the same lane in wrong driving direction


#### Decision on Initial Parameter Values

##### Response time

For the response times a common sense value for human drivers is about 2 seconds.
For an AV vehicle the response time could be way lower. In order to be not too
restrictive the initial value for the ego vehicle response time will be assumed
as 1 second. Hence, &rho;~other~ = 2 seconds and &rho;~ego~ = 1 second.

##### Acceleration

Finding meaningful acceleration values is more complicated.
At the one hand the values should be as close as possible or even exceed
the maximum physically possible values. The minimum deceleration values must
also not exceed normal human driving behavior. So assuming a too high deceleration
for other cars may lead to a false interpretation of the situation.

On the other hand a too big difference between the minimum and maximum acceleration
values will lead to a very defensive driving style. As a result, participating
in dense traffic, will not be possible (see Figure 1). A rule of thumb for deceleration in German
driving schools is: &alpha;~brake,min~ = 4 ùëö/s^2^ and &alpha;~brake,max~ = 8 ùëö/ùë†^2^

But on the other hand, modern cars are able to decelerate with up to 12 ùëö/ùë†^2^.
Especially for deceleration, it is questionable whether it is possible and tolerable
to restrict maximum braking below physically possible braking force.

For the maximum acceleration at low speeds a standard car will be in the range
of 3.4 ùëö/ùë†^2^ to 7 ùëö/ùë†^2^. But there are also sport cars that can go faster than that.
But for acceleration a regulation to a maximum value seems to be more likely than
for deceleration.

##### Restricting velocity to the current speed limit

.Required safety distance for cars driving at 50 km/h (city speed) in same direction with &alpha;~brake,min~ = 4 m/s^2^ and &alpha;~brake,max~ = 8 m/s^2^ and &rho; = 2 s
image::accelSafety.png[caption="Figure {counter:figure}. "]

The assumption that a car can always accelerate at &alpha;~accel,max~
during the reponse time, leads to a significant increase of the required safety distance.
Figure 1 shows the required safety distance for different acceleration values.
So acceleration about 4 ùëö/ùë†^2^ doubles the required safety distance from 40 m to
about 80 m at city speeds.

Therefore, it might be advisable to add a restriction that are car is only allowed to accelerate
up to the maximum allowed velocity.

##### Further possible restrictions

Another possibility to decrease the required safety distance to the leading
vehicle would be to take the intention of the ego vehicle into account.
E.g. if the ego vehicle is following another vehicle and is not intending
to accelerate. There is no need to assume that the ego vehicle is accelerating
during its response time. Nevertheless, there are several issues with that approach:

1. It needs to be assured that all intended and unintended accelerations
   (e.g. driving down a slope) are known to RSS
2. If RSS formulas are regarded as regulations, the safety distance must be kept
   regardless to the intent of the vehicle.

Therefore, in the current implementation this approach will not be applied.

[NOTE]
====
As a starting point the values are set to:

.Chosen Default Parameters
[width="100%",frame="topbot",options="header"]
|======================
| Parameter           | Value
| &rho;~ego~           | 1 ùë†
| &rho;~other~          | 2 ùë†
| &alpha;~accel,max~      | 3.5 ùëö/ùë†^2^
| &alpha;~brake,min~      | 4 ùëö/ùë†^2^
| &alpha;~brake,max~      | 8 ùëö/ùë†^2^
| &alpha;~brake,min,correct~   | 3 ùëö/ùë†^2^
|======================


====

### Summary

#### Key decisions
* RSS checks are performed on the current state on a ego vehicle - object pair basis
* In dangerous situations only braking maneuvers are issued. RSS does not initiate
  lateral evasive maneuvers.
* Lane-CS: TODO fill
* Proposed initial parameters are specified in Table 6.


#### Proposed changes / extensions to definitions in RSS paper

* To overcome the issue of enormous safety distances, even at low speeds (see
  Figure 1.), it might be advisable to restrict the acceleration such that the
  achievable velocities are always below the maximum allowed speed limit.

* When two vehicles are driving in opposite direction, but both cars "believe"
  that they are on the correct lane, both cars will brake with &alpha;~brake,min,correct~
  assuming that the other car slows down with &alpha;~brake,min~. However, this may
  not clear the dangerous situation. Therefore, it is important to introduce a
  special treatment for the case of opposing cars that both are on the correct lane.
  This handling is explained in Section 3.3.

* It cannot be determined whether lateral evasive maneuvers are actually possible.
Therefore, the RSS Module will not initiate such maneuvers, but will not hinder the
driving policy to execute lateral evasive maneuvers.

## Architecture Overview

++++
<iframe
  src="model/architecture/RSS-ArchitectureOverview.html"
  width="1024"
  onload="this.style.height=(this.contentDocument.body.scrollHeight + 15) + 'px';"
  frameBorder="0" >
</iframe>
++++

## High Level Design
// intended empty

### Static View
The static view on the system.
Add here e.g. block diagrams.
Might also be generated directly from Rhapsody

#### Modules
Here the blocks (or SW modules) from static view described, but only briefly

##### RSS-Core

##### RSS-Environment

#### Interfaces
// intended empty
Where the last section focuses on what blocks there are, this section describes the interfaces used, provided

##### External interfaces used

##### External interfaces provided

##### Internal interfaces

##### Configuration interfaces

##### Debug and Diagnostics interfaces


### Dynamic View

#### Partition to Tasks
#### Memory Management
#### Usage of Infrastructure
#### Resources Constraints
#### Error Handling
#### Flows
#### Initialization and Reset

### Design for Security
*TODO* Don't know if in the RSS library case we have anything special here.

### Design for Safety
*TODO* Maybe we should explain here the differentiation between
Functional Safety (FuSa) in general and the planning safety which RSS is covering.

Basic idea would be: In principle, RSS is implementing
safety of the intended functionality.
One can apply RSS without FuSa to safeguard the planning functionality.
If one implements RSS in an ADS with FuSa constraints on system level,
RSS contributes to the FuSa goals of the whole ADS.
