# High Level Design
// intended empty

## Key Design Decisions and Alternatives
// intended empty

### RSS checks and response
The RSS module is the entity performing all RSS checks and operations.
It will perform checks on the current state of the environment,
in order to determine if the ego vehicle is currently in a safe state.
If the ego vehicle is not in a safe state, the RSS module will provide a response
action that will bring the car back into a safe state.

The state is regarded as safe, if the ego vehicle is not causing a collision with
another object, under the worst case assumption that the ego vehicle will
accelerate at maximum possible speed during its response time.
Hence for this check the RSS module does not take the current desired behavior
as given by the driving policy into account.
However as the RSS modules makes a worst case assumption, it is guaranteed that
if the RSS module regards the situation as safe, no valid action of
the driving policy can bring the vehicle into an unsafe state.

If the vehicle is in a dangerous situation, RSS will assure a proper reaction
that will bring the car back into a safe state.
Therefore, it will check whether the driving policy responds correctly to the
situation.
If yes the command given by the driving policy will be executed. But if the
driving policy command is conflicting with the response that RSS expects,
RSS will prevent the command from being executed and will provide a proper
command instead.

This will assure that the vehicle reacts correctly. But the driving policy still
has the chance to solve the dangerous situation
on a more elaborate way than RSS would be able to, as RSS only has basic
information about the environment.

To check whether the ego vehicle is in a safe state, all the objects in the
surrounding must be respected. To do so the RSS module will perform an analysis
against all the objects in the environment individually. Meaning, for each
object in the environment the RSS module will check whether the ego vehicle
conflicts with this object.


### Lateral evasive maneuvers
If the car finds itself in a dangerous situation one possible action is always
to brake. According to the RSS papers, this should always result
in a safe state, but might lead in worst case to a complete stop of the vehicle.
The RSS paper proposes that the car may perform also lateral maneuvers as a
response to certain dangerous situations. To do so, it must be assured that
this lateral movement brings the vehicle into a safe state and does not conflict
with another vehicle.
In order to determine whether a lateral movement solves the conflict a
prediction of the state would be necessary.
However, such a prediction for all objects comes with a high uncertainty,
and therefore, would not be reliable.
In addition to that RSS just has only visibility of the objects in
the environment. It cannot determine that a lateral movement initiated by RSS
will cause an accident with static obstacles.

Therefore, it is impossible for the RSS module to detect whether a lateral
evasion is really feasible.
In order to guarantee that the dangerous situation is solved, RSS will restrict
the movement in the dangerous direction. Though, to allow the driving policy to
find a better escape for the current situation, the RSS response will not be
send directly to the actuators.
It will just make sure the command of the driving policy is not conflicting
with the response given by RSS.
With this approach e.g. in a scenario where another vehicle cuts into
the lane of the ego vehicle, RSS will propose a lateral deceleration towards
the intersecting car. Hence, it will neglect steering towards direction
of the other vehicle. But the driving policy can still steer to the
opposite direction e.g. on an adjacent lane to avoid a collision.


### Response for vehicles driving in opposite directions

If two vehicles are approaching each other in opposite direction and the lateral
distance between them is not safe, the RSS paper defines that the car that is on
its own lane can brake with lower force than the car on the opposite direction.
This definition leads to a correct behavior, if it is obvious that one car is on
its own lane and the other car is driving on the lane belonging to the other car.

However, there are situations where this cannot be determined.
One situation e.g. is that there is a bidirectional single lane road.
For sure on such a road each car should drive on the right side, but it cannot
 be easily detected which car is no longer on its side of the road.

Another situation is that there is a two lane road with one lane for each
direction. If each car drives on its own lane but is very close to the left
border, it could lead to a lateral conflict, as the safe lateral distance
requires a safety margin. In this situation both cars are on the correct lane,
but still there is a lateral conflict. In a real world scenario things can get
even worse.
As sensing will never be 100% accurate, small errors in the perception
system can lead to an interpretation that one or even both cars
believe that they are themselves on the correct lane and the other car is
on the wrong lane. Therefore, each car will brake with low force and expects
the other car to brake more strongly. Consequently, this dangerous situation
will never be solved and the cars will crash.

To avoid such a catastrophic situation, the RSS module
will extend the rule given by the paper to the following.

Given a situation that two cars approach each other with
a lateral conflict, the following rules apply:

1. Both cars must brake according to the "stated braking pattern",
   if the longitudinal distance is not safe given that both cars
   accelerate at maximum during their response time and brake with
   &alpha;~min,brake~ (as defined in the paper).

2. If case 1 does not apply, and the longitudinal distance is not safe
   according to the definition in "Safe Longitudinal Distance for Opposite Directions",
   the vehicle on the correct lane has to brake with &alpha;~min,brake,correct~,
   and the vehicle on the wrong lane has to conduct the "stated braking pattern"
   (This is the situation described in the RSS paper).

### Response Time
According to the papers each traffic participant has a response time.
Within this response time the participants (including the ego vehicle) are allowed
to accelerate, and thus increase their velocity.

In addition, the distance covered during the response time is part of the safe
distance, as defined by RSS. Hence, upon entering a dangerous situation,
it would be possible to accelerate for at most t < response time, as this
acceleration is already considered.

Nevertheless, the RSS module will immediately issue a response action (longitudinal
or lateral braking maneuver). To ensure that the dangerous situation is evaded
as fast as possible.



### Lane-Based Coordinate System
As described in the paper RSS assumes that all cars drive in parallel and
follow a straight line. Therefore, it is required to transform the object
states from Cartesian into Lane space. To be able to compare the velocities
of the objects both objects need to be in the same coordinate system. Therefore,
the RSS module will do the transformation into a space that covers both objects
and will not transform every single lane on its own. This transformation will
also transform the velocities of the objects into a velocity in the new coordinate
system. If the lanes in the Cartesian space are not parallel, this might lead
to a lateral acceleration when the car moves forward. As itâ€™s not easily possible
to define a closed formula for this acceleration, the RSS module will use min/max
values for calculating the safe distances. Therefore, it is assured that the
calculations are sound, nevertheless this might lead to a more cautious behavior
of the vehicle.


The RSS definitions assume that the road is comprised by adjacent,
straight lanes of constant width.
To cope with general lane geometries a lane-based coordinate system is introduced
which allows to apply the RSS definitions to any lane geometry.

The transformation into the lane-based coordinate system is described by a
bijective function.

Therein, the lateral position of a vehicle within the lane is mapped to a
parametric interval [0; 1].


#### Design Alternative Iterative Approach
@todo delete empty chapter

#### Design Alternative Closed Form
@todo delete empty chapter

### Parameter Definition and Alternatives
The RSS papers use a few constants required for the safety calculations.
The values for these constants are not defined and open for discussion/regulation.
Nevertheless, the implementation of the RSS modules needs to define initial values
for these functions. The parameters will be implemented as configuration values
so these can be easily adjusted during evaluation or after the release.

In the following, the key parameters and the decision for their initial values are
discussed. The used parameters are:

* Response time &rho;.
  It is assumed that an AV vehicle has a shorter response
  time than a human driver. Therefore, there is a need to have two different parameters.
  As it might not be possible to determine whether another object is an AV vehicle
  or has a human driver, the RSS module will safely assume that all other objects
  are driven by humans. Hence, two parameters for the response time are used.
** &rho;~ego~ for the ego vehicle
** &rho;~other~ for all other objects

* Acceleration &alpha;.
  RSS proposes several different acceleration/deceleration
  values. One could argue that acceleration/deceleration differs with the type
  of vehicle. Also at least the acceleration is dependent on the current vehicle speed.
  As it cannot be assured that the individual acceleration of each and every car
  can be known and the specific car can be reliably detected, the RSS module will
  assume fixed constants for those values. These could be either the maximum
  physically possible values or restrictions that are imposed by regulation.
  Also there will not be different values for the ego vehicle and the other vehicles.
  It could be argued that for the ego vehicle e.g. desired acceleration might be known.
  Therefore, a shorter safety distance would be sufficient. But as all other
  vehicles do not know about the intention of the ego vehicle this would lead
  to a violation of their safe space. So the RSS module will need to calculate
  its checks with the globally defined accelerations values even if the vehicle
  does not intend to utilize them to its limits.
  The parameters used for acceleration are:
** &alpha;~accel,max~ maximum possible acceleration
** &alpha;~brake,min~ minimum allowed braking deceleration for most scenarios
** &alpha;~brake,max~ maximum allowed deceleration
** &alpha;~brake,min,correct~ minimum allowed deceleration for a car on its lane with
   another car approaching on the same lane in wrong driving direction


#### Decision on Initial Parameter Values

##### Response time

For the response times a common sense value for human drivers is about 2 seconds.
For an AV vehicle the response time could be way lower. In order to be not too
restrictive the initial value for the ego vehicle response time will be assumed
as 1 second. Hence, &rho;~other~ = 2 seconds and &rho;~ego~ = 1 second.

##### Acceleration

Finding meaningful acceleration values is more complicated.
At the one hand the values should be as close as possible or even exceed
the maximum physically possible values. The minimum deceleration values must
also not exceed normal human driving behavior. So assuming a too high deceleration
for other cars may lead to a false interpretation of the situation.

On the other hand a too big difference between the minimum and maximum acceleration
values will lead to a very defensive driving style. As a result, participating
in dense traffic, will not be possible (see Figure 1). A rule of thumb for deceleration in German
driving schools is: &alpha;~brake,min~ = 4 ð‘š/s^2^ and &alpha;~brake,max~ = 8 ð‘š/ð‘ ^2^

But on the other hand, modern cars are able to decelerate with up to 12 ð‘š/ð‘ ^2^.
Especially for deceleration, it is questionable whether it is possible and tolerable
to restrict maximum braking below physically possible braking force.

For the maximum acceleration at low speeds a standard car will be in the range
of 3.4 ð‘š/ð‘ ^2^ to 7 ð‘š/ð‘ ^2^. But there are also sport cars that can go faster than that.
But for acceleration a regulation to a maximum value seems to be more likely than
for deceleration.

##### Restricting velocity to the current speed limit

.Required safety distance for cars driving at 50 km/h (city speed) in same direction with &alpha;~brake,min~ = 4 m/s^2^ and &alpha;~brake,max~ = 8 m/s^2^ and &rho; = 2 s
image::accelSafety.png[caption="Figure {counter:figure}. "]

The assumption that a car can always accelerate at &alpha;~accel,max~
during the reponse time, leads to a significant increase of the required safety distance.
Figure 1 shows the required safety distance for different acceleration values.
So acceleration about 4 ð‘š/ð‘ ^2^ doubles the required safety distance from 40 m to
about 80 m at city speeds.

Therefore, it might be advisable to add a restriction that are car is only allowed to accelerate
up to the maximum allowed velocity.

##### Further possible restrictions

Another possibility to decrease the required safety distance to the leading
vehicle would be to take the intention of the ego vehicle into account.
E.g. if the ego vehicle is following another vehicle and is not intending
to accelerate. There is no need to assume that the ego vehicle is accelerating
during its response time. Nevertheless, there are several issues with that approach:

1. It needs to be assured that all intended and unintended accelerations
   (e.g. driving down a slope) are known to RSS
2. If RSS formulas are regarded as regulations, the safety distance must be kept
   regardless to the intent of the vehicle.

Therefore, in the current implementation this approach will not be applied.

[NOTE]
====
As a starting point the values are set to:

.Chosen Default Parameters
[width="100%",frame="topbot",options="header"]
|======================
| Parameter           | Value
| &rho;~ego~           | 1 ð‘ 
| &rho;~other~          | 2 ð‘ 
| &alpha;~accel,max~      | 3.5 ð‘š/ð‘ ^2^
| &alpha;~brake,min~      | 4 ð‘š/ð‘ ^2^
| &alpha;~brake,max~      | 8 ð‘š/ð‘ ^2^
| &alpha;~brake,min,correct~   | 3 ð‘š/ð‘ ^2^
|======================


====

### Summary

#### Key decisions
* RSS checks are performed on the current state on a ego vehicle - object pair basis
* In dangerous situations only braking maneuvers are issued. RSS does not initiate
  lateral evasive maneuvers.
* Lane-CS: TODO fill
* Proposed initial parameters are specified in Table 6.


#### Proposed changes / extensions to definitions in RSS paper

* To overcome the issue of enormous safety distances, even at low speeds (see
  Figure 1.), it might be advisable to restrict the acceleration such that the
  achievable velocities are always below the maximum allowed speed limit.

* When two vehicles are driving in opposite direction, but both cars "believe"
  that they are on the correct lane, both cars will brake with &alpha;~brake,min,correct~
  assuming that the other car slows down with &alpha;~brake,min~. However, this may
  not clear the dangerous situation. Therefore, it is important to introduce a
  special treatment for the case of opposing cars that both are on the correct lane.
  This handling is explained in Section 3.3.

* It cannot be determined whether lateral evasive maneuvers are actually possible.
Therefore, the RSS Module will not initiate such maneuvers, but will not hinder the
driving policy to execute lateral evasive maneuvers.

## Architecture Overview

++++
<iframe
  src="model/architecture/RSS-ArchitectureOverview.html"
  width="1024"
  onload="this.style.height=(this.contentDocument.body.scrollHeight + 15) + 'px';"
  frameBorder="0" >
</iframe>
++++

## High Level Design
// intended empty

### Static View
The static view on the system.
Add here e.g. block diagrams.

#### Modules
:todo: Here the blocks (or SW modules) from static view described, but only briefly

##### RSS-Core

##### RSS-Environment

#### Interfaces
// intended empty
:todo: Where the last section focuses on what blocks there are, this section describes the interfaces used, provided

##### External interfaces used

##### External interfaces provided

##### Internal interfaces

##### Configuration interfaces

##### Debug and Diagnostics interfaces


### Dynamic View

#### Partition to Tasks
#### Memory Management
#### Usage of Infrastructure
#### Resources Constraints
#### Error Handling
#### Flows
#### Initialization and Reset

### Design for Security

### Design for Safety
